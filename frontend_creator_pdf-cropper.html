<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Cropper - JEE Mock Test</title>
    <link rel="stylesheet" href="../css/common.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        .cropper-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            margin-top: 20px;
        }
        .pdf-viewer {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .canvas-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            overflow: auto;
        }
        #pdfCanvas {
            border: 2px solid #e0e0e0;
            cursor: crosshair;
            max-width: 100%;
            display: block;
        }
        .crop-overlay {
            position: absolute;
            border: 2px dashed #667eea;
            background: rgba(102, 126, 234, 0.1);
            pointer-events: none;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .control-btn {
            width: 100%;
            margin-bottom: 10px;
        }
        .page-info {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 20px;
        }
        .crop-preview {
            width: 100%;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <ul class="nav-list">
            <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
            <li><a href="#" class="nav-link active">PDF Cropper</a></li>
            <li><button onclick="logout()" class="btn btn-sm btn-secondary" style="margin-left: auto;">Logout</button></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">Crop Questions from PDF</h1>
                <p id="testTitle" style="color: #666;"></p>
            </div>
        </div>

        <div class="cropper-container">
            <div class="pdf-viewer">
                <div class="page-info">
                    Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                </div>
                
                <div style="text-align: center; margin-bottom: 20px;">
                    <button onclick="previousPage()" class="btn btn-secondary">‚Üê Previous</button>
                    <button onclick="nextPage()" class="btn btn-secondary">Next ‚Üí</button>
                    <button onclick="zoomIn()" class="btn btn-secondary">üîç Zoom In</button>
                    <button onclick="zoomOut()" class="btn btn-secondary">üîç Zoom Out</button>
                </div>

                <div class="canvas-container" id="canvasContainer">
                    <canvas id="pdfCanvas"></canvas>
                    <div id="cropOverlay" class="crop-overlay" style="display: none;"></div>
                </div>

                <div style="margin-top: 20px; color: #666;">
                    <strong>Instructions:</strong>
                    <ol style="margin-top: 10px;">
                        <li>Click and drag on the PDF to select a question area</li>
                        <li>Make sure to include the entire question with all options</li>
                        <li>Click "Crop & Save" to save the selection</li>
                        <li>Continue to the next question or page</li>
                    </ol>
                </div>
            </div>

            <div class="controls">
                <h3 style="margin-bottom: 20px;">Crop Controls</h3>
                
                <div id="cropStatus" class="info-message" style="display: none;">
                    Crop area selected
                </div>
                
                <button onclick="cropAndSave()" class="btn btn-success control-btn" id="cropBtn" disabled>
                    ‚úÇÔ∏è Crop & Save
                </button>
                
                <button onclick="clearSelection()" class="btn btn-secondary control-btn">
                    ‚ùå Clear Selection
                </button>
                
                <hr style="margin: 20px 0;">
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">Cropped Questions</h4>
                    <div id="croppedCount" style="font-size: 2rem; font-weight: bold; color: #667eea; text-align: center;">
                        0
                    </div>
                </div>
                
                <img id="cropPreview" class="crop-preview" alt="Crop preview">
                
                <button onclick="finishCropping()" class="btn btn-primary control-btn" style="margin-top: 20px;">
                    ‚úÖ Finish & Add Question Details
                </button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script>
        requireAuth('creator');
        
        const urlParams = new URLSearchParams(window.location.search);
        const testId = urlParams.get('testId');
        
        if (!testId) {
            alert('No test ID provided');
            window.location.href = 'dashboard.html';
        }
        
        let pdfDoc = null;
        let currentPage = 1;
        let scale = 1.5;
        let isDrawing = false;
        let startX, startY, endX, endY;
        let croppedImages = [];
        
        const canvas = document.getElementById('pdfCanvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('cropOverlay');
        
        // Load test and PDF
        async function loadTest() {
            try {
                const data = await apiCall(`/tests/${testId}`);
                document.getElementById('testTitle').textContent = data.test.title;
                
                // Load PDF (you would get the PDF path from the backend)
                // For now, we'll use a sample approach
                // In production, fetch the PDF URL from the test data
                loadPDF();
            } catch (error) {
                alert('Failed to load test: ' + error.message);
            }
        }
        
        async function loadPDF() {
            // This is a placeholder - in production, you'd get the PDF URL from the backend
            const pdfPath = '/path/to/uploaded/pdf'; // Get this from API
            
            // Note: In a real implementation, you would:
            // 1. Get the PDF file path from the test data
            // 2. Serve it through your backend
            // 3. Load it using PDF.js
            
            pdfjsLib.GlobalWorkerOptions.workerSrc = 
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            
            // Example: Load a sample PDF (replace with actual PDF from backend)
            alert('PDF loading functionality requires backend PDF URL. Please ensure PDF is uploaded and accessible.');
        }
        
        function renderPage(pageNum) {
            pdfDoc.getPage(pageNum).then(page => {
                const viewport = page.getViewport({ scale });
                
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };
                
                page.render(renderContext);
                
                document.getElementById('currentPage').textContent = pageNum;
            });
        }
        
        function previousPage() {
            if (currentPage <= 1) return;
            currentPage--;
            renderPage(currentPage);
            clearSelection();
        }
        
        function nextPage() {
            if (currentPage >= pdfDoc.numPages) return;
            currentPage++;
            renderPage(currentPage);
            clearSelection();
        }
        
        function zoomIn() {
            scale += 0.25;
            renderPage(currentPage);
        }
        
        function zoomOut() {
            if (scale <= 0.5) return;
            scale -= 0.25;
            renderPage(currentPage);
        }
        
        // Canvas crop selection
        canvas.addEventListener('mousedown', (e) => {
            const rect = canvas.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            isDrawing = true;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            endX = e.clientX - rect.left;
            endY = e.clientY - rect.top;
            
            const width = endX - startX;
            const height = endY - startY;
            
            overlay.style.display = 'block';
            overlay.style.left = startX + 'px';
            overlay.style.top = startY + 'px';
            overlay.style.width = Math.abs(width) + 'px';
            overlay.style.height = Math.abs(height) + 'px';
        });
        
        canvas.addEventListener('mouseup', () => {
            if (isDrawing) {
                isDrawing = false;
                document.getElementById('cropStatus').style.display = 'block';
                document.getElementById('cropBtn').disabled = false;
            }
        });
        
        function clearSelection() {
            overlay.style.display = 'none';
            document.getElementById('cropStatus').style.display = 'none';
            document.getElementById('cropBtn').disabled = true;
            document.getElementById('cropPreview').style.display = 'none';
        }
        
        async function cropAndSave() {
            const cropX = Math.min(startX, endX);
            const cropY = Math.min(startY, endY);
            const cropWidth = Math.abs(endX - startX);
            const cropHeight = Math.abs(endY - startY);
            
            // Create temporary canvas for crop
            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = cropWidth;
            cropCanvas.height = cropHeight;
            const cropCtx = cropCanvas.getContext('2d');
            
            // Draw cropped area
            cropCtx.drawImage(canvas, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
            
            // Convert to base64
            const imageData = cropCanvas.toDataURL('image/jpeg', 0.9);
            
            // Show preview
            const preview = document.getElementById('cropPreview');
            preview.src = imageData;
            preview.style.display = 'block';
            
            try {
                // Save to backend
                const response = await apiCall('/questions/save-crop', {
                    method: 'POST',
                    body: JSON.stringify({ imageData })
                });
                
                croppedImages.push(response.imageUrl);
                document.getElementById('croppedCount').textContent = croppedImages.length;
                
                clearSelection();
                alert('Question cropped and saved successfully!');
            } catch (error) {
                alert('Failed to save crop: ' + error.message);
            }
        }
        
        function finishCropping() {
            if (croppedImages.length === 0) {
                alert('Please crop at least one question before proceeding');
                return;
            }
            
            // Save cropped images to session storage for the question editor
            sessionStorage.setItem('croppedImages', JSON.stringify(croppedImages));
            sessionStorage.setItem('currentTestId', testId);
            
            window.location.href = 'question-editor.html';
        }
        
        loadTest();
    </script>
</body>
</html>
